<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>High & Low ã‚²ãƒ¼ãƒ </title>
    <style>
        /* ã“ã“ã«æä¾›ã•ã‚ŒãŸç”»åƒã«åˆã‚ã›ãŸç°¡æ˜“çš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨˜è¿°ã—ã¾ã™ */
        body {
            background-color: rgb(57, 198, 152); /* ã‚¤ãƒ¡ãƒ¼ã‚¸å›³ã®èƒŒæ™¯è‰²ã«è¿‘ã„ç·‘ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .container {
            width: 800px;
            padding: 30px;
            border: 5px solid #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®æ ç·š */
            border-radius: 10px;
            background-color: rgb(57, 198, 166);
            display: grid;
            grid-template-areas:
                "home bet reset medal"
                "card1 card2 high low"
                "card1 card2 high low"
                "bet1 bet5 bet10 bet50";
            grid-template-columns: 1fr 1fr 150px 150px;
            grid-template-rows: auto auto auto 80px;
            gap: 20px;
            align-items: center;
            justify-items: center;
        }
        .home-btn {
            grid-area: home;
			font-size: 20px;
            justify-self: start;
            padding: 15px 30px;
            background-color: rgb(185, 177, 30); 
            color: black;
            border: 4px solid rgb(175, 98, 217);
            cursor: pointer;
			margin-top: -30px;
			margin-left: -30px;
        }
        .bet-count {
            grid-area: bet;
            background-color: black;
            color: white;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 24px;
        }
        .reset-btn {
            grid-area: reset;
            background-color: #d32f2f; /* èµ¤ç³»ã®ãƒœã‚¿ãƒ³ */
            color: white;
            padding: 10px 20px;
            cursor: pointer;
        }
        .medal-count {
            grid-area: medal;
			background-color: white;
            padding: 10px;
            border: 4px solid black;
            font-size: 18px;
        }
		.card {
			width: 90%;
			aspect-ratio: 2 / 3;
			/*border: 1px solid black;
			/*background-color: white;
			/* æ¬¡ã®3è¡Œã¯ä¸è¦ã¾ãŸã¯å¤‰æ›´ã®å¯èƒ½æ€§ã‚ã‚Š */
			/* display: flex; */
			/* justify-content: center; */
			/* align-items: center; */
			/* font-size: 1.2em; */
			overflow: hidden; /* ç”»åƒãŒæ ã‚’è¶…ãˆã‚‹ã®ã‚’é˜²ã */
		}
        .card1 { grid-area: card1; }
        .card2 { grid-area: card2; }
        .high-btn, .low-btn {
            background-color: #8d3a1f; /* èµ¤èŒ¶è‰²ã®ãƒœã‚¿ãƒ³ */
            color:rgb(220, 205, 20);
            font-size: 24px;
			font-weight: bold;
            padding: 20px;
            width: 100%;
			border: 4px solid rgb(176, 143, 55);
            cursor: pointer;
        }
        .high-btn { grid-area: high; }
        .low-btn { grid-area: low; }
        .bet-btn {
            background-color: #8d3a1f;
            color: white;
            font-size: 18px;
            padding: 15px 30px;
            width: 100%;
            cursor: pointer;
            border: none;
        }
        .bet1-btn { grid-area: bet1; }
        .bet5-btn { grid-area: bet5; }
        .bet10-btn { grid-area: bet10; }
        .bet50-btn { grid-area: bet50; }
        /* ã‚²ãƒ¼ãƒ çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« (ä»»æ„) */
        .message {
            grid-column: 1 / span 4;
            text-align: center;
            color: yellow;
            font-size: 20px;
        }
		
		/* -------- popup -------- */
		.popup {
		    position:absolute;
		    bottom:0;
		    left:0;
		    width:100%;
		    background:rgba(0,0,0,0.8);
		    color:white;
		    padding:20px;
		    text-align:center;
		}

		.popup-content {
		    margin:auto;
		    font-size:22px;
		}

		.popup button {
		    margin-top:10px;
		    padding:10px 20px;
		    font-size:20px;
		    cursor:pointer;
		}

    </style>
</head>
<body>
    <div class="container">
        <form th:action="@{/home}" method="get">
            <button type="submit" class="home-btn">HOME</button>
        </form>

        <div class="bet-count">
            <span th:text="${betCount}" id="HLBetMedal">0</span> </div>

        <button type="button" class="reset-btn" onclick="resetBet()">RESET</button>

        <div class="medal-count">
            æ‰€æŒãƒ¡ãƒ€ãƒ«æ•°: <span th:text="${user.myMedal}" id="Mymedal">5000</span> </div>

			<div class="card card1">
				<img id="faceUpCardImage" th:src="@{'/images/cards/' + ${faceUpCard} + '.png'}" 
			    	alt="è¡¨å‘ãã®ã‚«ãƒ¼ãƒ‰" style="width: 100%; height: 100%; object-fit: contain;">
			</div>

			<div class="card card2">
				<img id="faceDownCardImage" th:src="@{/images/cards/back.png}" 
			    	alt="è£å‘ãã®ã‚«ãƒ¼ãƒ‰" style="width: 100%; height: 100%; object-fit: contain;">
			</div>
			
        <button type="button" class="high-btn" onclick="placeBet('HIGH')">HIGH</button>

        <button type="button" class="low-btn" onclick="placeBet('LOW')">LOW</button>
		
		<!-- â˜… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆçµæœè¡¨ç¤ºï¼‰ -->
		<div id="resultPopup" class="popup" style="display:none;">
		    <div class="popup-content">
		        <p id="popupResult"></p>
		        <p id="popupCards"></p>
		        <button onclick="closePopup()">NEXT</button>
		    </div>
		</div>


        <div class="message" id="game-message"></div>

        <button type="button" class="bet-btn bet1-btn" onclick="addBet(1)">1BET</button>

        <button type="button" class="bet-btn bet5-btn" onclick="addBet(5)">5BET</button>

        <button type="button" class="bet-btn bet10-btn" onclick="addBet(10)">10BET</button>

        <button type="button" class="bet-btn bet50-btn" onclick="addBet(50)">50BET</button>
    </div>

	<script>
	    const betCountElement = document.getElementById('HLBetMedal');
	    const myMedalElement = document.getElementById('Mymedal');
	    const gameMessage = document.getElementById('game-message');

	    let currentBet = parseInt(betCountElement.textContent);
	    let currentMedal = parseInt(myMedalElement.textContent);

		/*
		window.onload = () => {
			document.querySelector('.card1 span').textContent =
		    	document.getElementById("faceUpCard").textContent;

		    document.querySelector('.card2 span').textContent =
		        document.getElementById("faceDownCard").textContent;
		};
		*/
		
		function getCardImagePath(cardValue) {
			        if (cardValue === '?' || !cardValue) {
			            return '/images/cards/back.png';
			        }
			        // ç’°å¢ƒã«åˆã‚ã›ã¦ãƒ‘ã‚¹ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ (ä¾‹: Thmyeleafã®@{}ã‚’ä½¿ã‚ãªã„å ´åˆã¯é™çš„ãªãƒ‘ã‚¹)
			        return `/images/cards/${cardValue}.png`;
			    }
			
	    function updateBetDisplay() {
	        betCountElement.textContent = currentBet;
	    }

	    function addBet(amount) {
	        currentMedal = parseInt(myMedalElement.textContent); // æœ€æ–°ã®ãƒ¡ãƒ€ãƒ«æ•°
	        if (currentBet + amount > 999) {
	            gameMessage.textContent = 'ãƒ™ãƒƒãƒˆã¯999æšã¾ã§ã§ã™ã€‚';
	            return;
	        }
	        if (currentBet + amount > currentMedal) {
	            gameMessage.textContent = 'æ‰€æŒãƒ¡ãƒ€ãƒ«æ•°ã‚’è¶…ãˆã¦ãƒ™ãƒƒãƒˆã§ãã¾ã›ã‚“ã€‚';
	            return;
	        }
	        currentBet += amount;
	        updateBetDisplay();
	        gameMessage.textContent = '';
	    }

	    function resetBet() {
	        currentBet = 0;
	        updateBetDisplay();
	        gameMessage.textContent = '';
	    }

	    // ğŸ® HIGH / LOW ãƒœã‚¿ãƒ³æŠ¼ä¸‹
	    function placeBet(choice) {
	        if (currentBet <= 0) {
	            gameMessage.textContent = 'ãƒ™ãƒƒãƒˆæ•°ãŒ0æšã§ã™ã€‚';
	            return;
	        }

	        // Controller ã¸é€ä¿¡ã™ã‚‹ JSON
	        const requestBody = {
	            betAmount: currentBet,
	            choice: choice
	        };

	        fetch('/api/highlow/play', {
	            method: 'POST',
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify(requestBody)
	        })
	        .then(res => {
	            if (!res.ok) {
	                throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
	            }
	            return res.json();
	        })
			.then(data => {
				const faceDownCardImage = document.getElementById("faceDownCardImage");

			    // â˜… è£å‘ãã‚«ãƒ¼ãƒ‰ã‚’ã²ã£ãã‚Šè¿”ã™
			    //document.querySelector('.card2 span').textContent = data.newCard;
				faceDownCardImage.src = `/images/cards/${data.newCard}.png`;

			    // â˜… çµæœã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«è¡¨ç¤º
			    const popup = document.getElementById("resultPopup");
			    document.getElementById("popupResult").textContent =
			        (data.result === "WIN")
			            ? `WINï¼ï¼ +${data.medalChange} ãƒ¡ãƒ€ãƒ«`
			            : `LOSE... ${data.medalChange} ãƒ¡ãƒ€ãƒ«`;

			    document.getElementById("popupCards").textContent =
			        `è¡¨:${data.faceUpCard}  è£:${data.newCard}`;

			    popup.style.display = "block";

			    myMedalElement.textContent = data.newMedal;

			    currentBet = 0;
			    updateBetDisplay();
			})

	        .catch(error => {
	            console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error);
	            gameMessage.textContent = 'é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
	        });
	    }
		
		function closePopup() {
		    document.getElementById("resultPopup").style.display = "none";
			const faceUpCardImage = document.getElementById("faceUpCardImage");
			const faceDownCardImage = document.getElementById("faceDownCardImage");

		    // â˜… æ–°ã—ã„è¡¨å‘ãã‚«ãƒ¼ãƒ‰ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆAPIã§å†ç”Ÿæˆã™ã‚‹ï¼‰
		    fetch('/api/highlow/newgame')
		        .then(res => res.json())
		        .then(data => {
		            //document.querySelector('.card1 span').textContent = data.faceUpCard;
		            //document.querySelector('.card2 span').textContent = "?";
					faceUpCardImage.src = `/images/cards/${data.faceUpCard}.png`;
					faceDownCardImage.src = `/images/cards/back.png`;
		        });
		}

	</script>

</body>
</html>